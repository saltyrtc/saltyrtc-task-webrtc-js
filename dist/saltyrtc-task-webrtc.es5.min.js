/**
 * saltyrtc-task-webrtc v0.14.1
 * A SaltyRTC WebRTC task v1 implementation.
 * https://github.com/saltyrtc/saltyrtc-task-webrtc-js#readme
 *
 * Copyright (C) 2016-2019 Threema GmbH
 *
 * This software may be modified and distributed under the terms
 * of the MIT license:
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var saltyrtcTaskWebrtc=function(e){function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function t(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function s(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var a=function(){function a(e,t,n,i){l(this,a),this.cookie=e,this.overflow=n,this.sequenceNumber=i,this.channelId=t}return t(a,[{key:"toUint8Array",value:function(){var e=new Uint8Array(a.TOTAL_LENGTH);e.set(this.cookie.bytes);var t=new DataView(e.buffer,e.byteOffset,e.byteLength);return t.setUint16(16,this.channelId),t.setUint16(18,this.overflow),t.setUint32(20,this.sequenceNumber),e}},{key:"combinedSequenceNumber",get:function(){return this.overflow*Math.pow(2,32)+this.sequenceNumber}}],[{key:"fromUint8Array",value:function(e){if(e.byteLength!==this.TOTAL_LENGTH)throw new saltyrtcClient.exceptions.ValidationError("Bad packet length");var t=new DataView(e.buffer,e.byteOffset,this.TOTAL_LENGTH),n=new Uint8Array(e.buffer,e.byteOffset,saltyrtcClient.Cookie.COOKIE_LENGTH);return new a(new saltyrtcClient.Cookie(n),t.getUint16(16),t.getUint16(18),t.getUint32(20))}}]),a}();a.TOTAL_LENGTH=24;var n=function(){function n(e,t){l(this,n),this.lastIncomingCsn=null,this.channelId=e,this.signaling=t,this.cookiePair=new saltyrtcClient.CookiePair,this.csnPair=new saltyrtcClient.CombinedSequencePair}return t(n,[{key:"encrypt",value:function(e){var t=this.csnPair.ours.next(),n=new a(this.cookiePair.ours,this.channelId,t.overflow,t.sequenceNumber);return this.signaling.encryptForPeer(e,n.toUint8Array())}},{key:"decrypt",value:function(e){var t;try{t=a.fromUint8Array(e.nonce)}catch(e){throw new saltyrtcClient.exceptions.ValidationError("Unable to create nonce, reason: ".concat(e))}if(t.cookie.equals(this.cookiePair.ours))throw new saltyrtcClient.exceptions.ValidationError("Local and remote cookie are equal");if(null===this.cookiePair.theirs||void 0===this.cookiePair.theirs)this.cookiePair.theirs=t.cookie;else if(!t.cookie.equals(this.cookiePair.theirs))throw new saltyrtcClient.exceptions.ValidationError("Remote cookie changed");if(null!==this.lastIncomingCsn&&t.combinedSequenceNumber===this.lastIncomingCsn)throw new saltyrtcClient.exceptions.ValidationError("CSN reuse detected");if(t.channelId!==this.channelId){throw new saltyrtcClient.exceptions.ValidationError("Data channel id in nonce does not match")}return this.lastIncomingCsn=t.combinedSequenceNumber,this.signaling.decryptFromPeer(e)}}]),n}();n.OVERHEAD_LENGTH=40,n.NONCE_LENGTH=a.TOTAL_LENGTH;var r=function(){function n(e,t){l(this,n),this.label="saltyrtc-signaling",this.id=e,this.protocol=t,this.untie()}return t(n,[{key:"untie",value:function(){this.closed=function(){throw new Error("closed: Not tied to a SignalingTransport")},this.receive=function(){throw new Error("receive: Not tied to a SignalingTransport")}}},{key:"tie",value:function(e){this.closed=e.closed.bind(e),this.receive=e.receiveChunk.bind(e)}}]),n}(),o=function(){function o(e,t,n,i,a,s,r){l(this,o),this.logTag="[SaltyRTC.WebRTC.SignalingTransport]",this.messageId=0,this.log=new saltyrtcClient.Log(s),this.link=e,this.handler=t,this.task=n,this.signaling=i,this.crypto=a,this.chunkLength=Math.min(this.handler.maxMessageSize,r),this.chunkBuffer=new ArrayBuffer(this.chunkLength),this.messageQueue=this.signaling.handoverState.peer?null:[],this.unchunker=new chunkedDc.UnreliableUnorderedUnchunker,this.unchunker.onMessage=this.receiveMessage.bind(this),this.link.tie(this),this.log.info(this.logTag,"Signaling transport created")}return t(o,[{key:"closed",value:function(){this.log.info("Closed (remote)"),this.unbind(),this.signaling.handoverState.any&&this.signaling.setState("closed")}},{key:"receiveChunk",value:function(e){this.log.debug(this.logTag,"Received chunk");try{this.unchunker.add(e)}catch(e){return this.log.error(this.logTag,"Invalid chunk:",e),this.die()}}},{key:"receiveMessage",value:function(e){this.log.debug(this.logTag,"Received message");var t=saltyrtcClient.Box.fromUint8Array(e,n.NONCE_LENGTH);try{e=this.crypto.decrypt(t)}catch(e){return this.log.error(this.logTag,"Invalid nonce:",e),this.die()}this.signaling.handoverState.peer?this.signaling.onSignalingPeerMessage(e):this.messageQueue.push(e)}},{key:"flushMessageQueue",value:function(){if(!this.signaling.handoverState.peer)throw new Error("Remote did not request handover");var e=!0,t=!1,n=void 0;try{for(var i,a=this.messageQueue[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var s=i.value;this.signaling.onSignalingPeerMessage(s)}}catch(e){t=!0,n=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw n}}this.messageQueue=null}},{key:"send",value:function(e){this.log.debug(this.logTag,"Sending message"),e=this.crypto.encrypt(e).toUint8Array();var t=new chunkedDc.UnreliableUnorderedChunker(this.messageId++,e,this.chunkLength,this.chunkBuffer),n=!0,i=!1,a=void 0;try{for(var s,r=t[Symbol.iterator]();!(n=(s=r.next()).done);n=!0){var o=s.value;this.log.debug(this.logTag,"Sending chunk");try{this.handler.send(o)}catch(e){return this.log.error(this.logTag,"Unable to send chunk:",e),this.die()}}}catch(e){i=!0,a=e}finally{try{n||null==r.return||r.return()}finally{if(i)throw a}}}},{key:"close",value:function(){try{this.handler.close()}catch(e){this.log.error(this.logTag,"Unable to close data channel:",e)}this.log.info("Closed (local)"),this.unbind()}},{key:"die",value:function(){this.log.warn(this.logTag,"Closing task due to an error"),this.task.close(saltyrtcClient.CloseCode.ProtocolError)}},{key:"unbind",value:function(){this.link.untie(),this.unchunker.onMessage=void 0}}]),o}(),h=function(){function e(){l(this,e),this.version="v1",this.logLevel="none",this.handover=!0,this.maxChunkLength=262144}return t(e,[{key:"withLoggingLevel",value:function(e){return this.logLevel=e,this}},{key:"withVersion",value:function(e){return this.version=e,this}},{key:"withHandover",value:function(e){return this.handover=e,this}},{key:"withMaxChunkLength",value:function(e){if(e<=chunkedDc.UNRELIABLE_UNORDERED_HEADER_LENGTH)throw new Error("Maximum chunk length must be greater than chunking overhead");return this.maxChunkLength=e,this}},{key:"build",value:function(){return new g(this.version,this.logLevel,this.handover,this.maxChunkLength)}}]),e}(),g=function(){function a(e,t,n,i){l(this,a),this.logTag="[SaltyRTC.WebRTC]",this.initialized=!1,this.exclude=new Set,this.link=null,this.transport=null,this.eventRegistry=new saltyrtcClient.EventRegistry,this.candidates=[],this.sendCandidatesTimeout=null,this.version=e,this.log=new saltyrtcClient.Log(t),this.doHandover=n,this.maxChunkLength=i}return t(a,[{key:"init",value:function(e,t){this.processExcludeList(t[a.FIELD_EXCLUDE]),this.processHandover(t[a.FIELD_HANDOVER]),"v0"===this.version&&this.processMaxPacketSize(t[a.FIELD_MAX_PACKET_SIZE]),this.signaling=e,this.initialized=!0}},{key:"processExcludeList",value:function(e){var t=!0,n=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var r=a.value;this.exclude.add(r)}}catch(e){n=!0,i=e}finally{try{t||null==s.return||s.return()}finally{if(n)throw i}}for(var o=0;o<65535;o++)if(!this.exclude.has(o)){this.channelId=o;break}if(void 0===this.channelId&&this.doHandover)throw new Error("No free data channel id can be found")}},{key:"processHandover",value:function(e){!1===e&&(this.doHandover=!1)}},{key:"processMaxPacketSize",value:function(e){var t=this.maxChunkLength;if(!Number.isInteger(e))throw new RangeError(a.FIELD_MAX_PACKET_SIZE+" field must be an integer");if(e<0)throw new RangeError(a.FIELD_MAX_PACKET_SIZE+" field must be positive");0<e&&(this.maxChunkLength=Math.min(t,e)),this.log.debug(this.logTag,"Max packet size: Local requested ".concat(t)+" bytes, remote requested ".concat(e," bytes. Using ").concat(this.maxChunkLength,"."))}},{key:"onPeerHandshakeDone",value:function(){}},{key:"onDisconnected",value:function(e){this.emit({type:"disconnected",data:e})}},{key:"onTaskMessage",value:function(e){switch(this.log.debug(this.logTag,"New task message arrived: "+e.type),e.type){case"offer":if(!0!==this.validateOffer(e))return;this.emit({type:"offer",data:e.offer});break;case"answer":if(!0!==this.validateAnswer(e))return;this.emit({type:"answer",data:e.answer});break;case"candidates":if(!0!==this.validateCandidates(e))return;this.emit({type:"candidates",data:e.candidates});break;case"handover":if(!this.doHandover){this.log.error(this.logTag,"Received unexpected handover message from peer"),this.signaling.resetConnection(saltyrtcClient.CloseCode.ProtocolError);break}if(this.signaling.handoverState.peer){this.log.warn(this.logTag,"Handover already received");break}this.signaling.handoverState.peer=!0,null!==this.transport&&this.transport.flushMessageQueue(),this.signaling.handoverState.both&&this.log.info(this.logTag,"Handover to data channel finished");break;default:this.log.error(this.logTag,"Received message with unknown type:",e.type)}}},{key:"validateOffer",value:function(e){return void 0===e.offer?(this.log.warn(this.logTag,"Offer message does not contain offer"),!1):void 0!==e.offer.sdp||(this.log.warn(this.logTag,"Offer message does not contain offer sdp"),!1)}},{key:"validateAnswer",value:function(e){return void 0===e.answer?(this.log.warn(this.logTag,"Answer message does not contain answer"),!1):void 0!==e.answer.sdp||(this.log.warn(this.logTag,"Answer message does not contain answer sdp"),!1)}},{key:"validateCandidates",value:function(e){if(void 0===e.candidates)return this.log.warn(this.logTag,"Candidates message does not contain candidates"),!1;if(e.candidates.length<1)return this.log.warn(this.logTag,"Candidates message contains empty candidate list"),!1;var t=!0,n=!1,i=void 0;try{for(var a,s=e.candidates[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var r=a.value;if(null!==r){if("string"!=typeof r.candidate&&!(r.candidate instanceof String))return this.log.warn(this.logTag,"Candidates message contains invalid candidate (candidate field)"),!1;if("string"!=typeof r.sdpMid&&!(r.sdpMid instanceof String)&&null!==r.sdpMid)return this.log.warn(this.logTag,"Candidates message contains invalid candidate (sdpMid field)"),!1;if(null!==r.sdpMLineIndex&&!Number.isInteger(r.sdpMLineIndex))return this.log.warn(this.logTag,"Candidates message contains invalid candidate (sdpMLineIndex field)"),!1}}}catch(e){n=!0,i=e}finally{try{t||null==s.return||s.return()}finally{if(n)throw i}}return!0}},{key:"sendSignalingMessage",value:function(e){if("task"!=this.signaling.getState())throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Signaling state is not 'task'.");if(!this.signaling.handoverState.local)throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Handover hasn't happened yet.");if(null===this.transport)throw new saltyrtcClient.SignalingError(saltyrtcClient.CloseCode.ProtocolError,"Could not send signaling message: Data channel is not established, yet.");this.transport.send(e)}},{key:"getName",value:function(){return"".concat(this.version,".webrtc.tasks.saltyrtc.org")}},{key:"getSupportedMessageTypes",value:function(){return["offer","answer","candidates","handover"]}},{key:"getData",value:function(){var e={};return e[a.FIELD_EXCLUDE]=Array.from(this.exclude.values()),e[a.FIELD_HANDOVER]=this.doHandover,"v0"===this.version&&(e[a.FIELD_MAX_PACKET_SIZE]=this.maxChunkLength),e}},{key:"sendOffer",value:function(e){this.log.debug(this.logTag,"Sending offer");try{this.signaling.sendTaskMessage({type:"offer",offer:{type:e.type,sdp:e.sdp}})}catch(e){"SignalingError"===e.name&&(this.log.error(this.logTag,"Could not send offer:",e.message),this.signaling.resetConnection(e.closeCode))}}},{key:"sendAnswer",value:function(e){this.log.debug(this.logTag,"Sending answer");try{this.signaling.sendTaskMessage({type:"answer",answer:{type:e.type,sdp:e.sdp}})}catch(e){"SignalingError"===e.name&&(this.log.error(this.logTag,"Could not send answer:",e.message),this.signaling.resetConnection(e.closeCode))}}},{key:"sendCandidate",value:function(e){this.sendCandidates([e])}},{key:"sendCandidates",value:function(e){var t,n=this;this.log.debug(this.logTag,"Buffering",e.length,"candidate(s)"),(t=this.candidates).push.apply(t,s(e));null===this.sendCandidatesTimeout&&(this.sendCandidatesTimeout=self.setTimeout(function(){try{n.log.debug(n.logTag,"Sending",n.candidates.length,"candidate(s)"),n.signaling.sendTaskMessage({type:"candidates",candidates:n.candidates})}catch(e){"SignalingError"===e.name&&(n.log.error(n.logTag,"Could not send candidates:",e.message),n.signaling.resetConnection(e.closeCode))}finally{n.candidates=[],n.sendCandidatesTimeout=null}},a.CANDIDATE_BUFFERING_MS))}},{key:"getTransportLink",value:function(){if(this.log.debug(this.logTag,"Create signalling transport link"),!this.doHandover)throw new Error("Handover has not been negotiated");if(void 0===this.channelId){throw new Error("Data channel id not set")}return null===this.link&&(this.link=new r(this.channelId,this.getName())),this.link}},{key:"handover",value:function(e){if(this.log.debug(this.logTag,"Initiate handover"),!this.doHandover)throw new Error("Handover has not been negotiated");if(this.signaling.handoverState.local||null!==this.transport)throw new Error("Handover already requested");var t=this.createCryptoContext(this.channelId);this.transport=new o(this.link,e,this,this.signaling,t,this.log.level,this.maxChunkLength),this.sendHandover()}},{key:"sendHandover",value:function(){this.log.debug(this.logTag,"Sending handover");try{this.signaling.sendTaskMessage({type:"handover"})}catch(e){"SignalingError"===e.name&&(this.log.error(this.logTag,"Could not send handover message",e.message),this.signaling.resetConnection(e.closeCode))}this.signaling.handoverState.local=!0,this.signaling.handoverState.both&&this.log.info(this.logTag,"Handover to data channel finished")}},{key:"createCryptoContext",value:function(e){return new n(e,this.signaling)}},{key:"close",value:function(e){this.log.debug(this.logTag,"Closing signaling data channel:",saltyrtcClient.explainCloseCode(e)),null!==this.transport&&this.transport.close(),this.transport=null}},{key:"on",value:function(e,t){this.eventRegistry.register(e,t)}},{key:"once",value:function(e,i){var a=this;this.eventRegistry.register(e,function t(n){try{i(n)}catch(e){throw a.off(n.type,t),e}a.off(n.type,t)})}},{key:"off",value:function(e,t){void 0===e?this.eventRegistry.unregisterAll():this.eventRegistry.unregister(e,t)}},{key:"emit",value:function(t){this.log.debug(this.logTag,"New event:",t.type);var e=this.eventRegistry.get(t.type),n=!0,i=!1,a=void 0;try{for(var s,r=e[Symbol.iterator]();!(n=(s=r.next()).done);n=!0){var o=s.value;try{this.callHandler(o,t)}catch(e){this.log.error(this.logTag,"Unhandled exception in",t.type,"handler:",e)}}}catch(e){i=!0,a=e}finally{try{n||null==r.return||r.return()}finally{if(i)throw a}}}},{key:"callHandler",value:function(e,t){!1===e(t)&&this.eventRegistry.unregister(t.type,e)}},{key:"signaling",set:function(e){this._signaling=e,this.logTag="[SaltyRTC.WebRTC."+e.role+"]"},get:function(){return this._signaling}}]),a}();return g.FIELD_EXCLUDE="exclude",g.FIELD_HANDOVER="handover",g.FIELD_MAX_PACKET_SIZE="max_packet_size",g.CANDIDATE_BUFFERING_MS=5,e.DataChannelCryptoContext=n,e.WebRTCTaskBuilder=h,e}({});
